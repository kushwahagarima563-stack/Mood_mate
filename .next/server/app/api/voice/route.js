"use strict";(()=>{var e={};e.id=323,e.ids=[323],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},71568:e=>{e.exports=require("zlib")},39349:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>x,requestAsyncStorage:()=>U,routeModule:()=>E,serverHooks:()=>B,staticGenerationAsyncStorage:()=>y});var o={};r.r(o),r.d(o,{POST:()=>w,maxDuration:()=>f,runtime:()=>p});var i=r(49303),s=r(88716),a=r(60670),n=r(87070),l=r(62632),u=r(72331);let d=process.env.AUDIO_BUCKET||"audio_analyses",c=process.env.DEEPGRAM_API_KEY,p="nodejs",f=60;async function h(e){if(console.log("[DEBUG] getSignedUrlIfNeeded called with:",e),e.startsWith("http"))return e;let{data:t,error:r}=await l.p.storage.from(d).createSignedUrl(e,300);if(r||!t?.signedUrl)throw console.error("[DEBUG] Supabase signed URL creation error:",r),Error("Failed to create signed URL. Check bucket name and file path.");return console.log("[DEBUG] Signed URL created successfully."),t.signedUrl}async function g(e){console.log("[DEBUG] downloadAsBlob called with URL:",e);let t=await fetch(e);if(!t.ok)throw console.error("[DEBUG] Audio download failed:",t.status,t.statusText),Error(`Failed to download audio: ${t.status} ${t.statusText}`);let r=await t.arrayBuffer();if(0===r.byteLength)throw Error("Downloaded audio file is empty.");return console.log("[DEBUG] Audio downloaded successfully, size:",r.byteLength),new Blob([r])}async function m(e){if(!c)throw Error("DEEPGRAM_API_KEY is not configured in environment variables.");if(0===e.size)return console.warn("[DEBUG] Audio file is empty, returning empty transcript."),"";let t=new FormData;t.append("file",new File([e],"audio.webm",{type:"audio/webm"}));let r=await fetch("https://api.deepgram.com/v1/listen?punctuate=true",{method:"POST",headers:{Authorization:`Token ${c}`},body:t});if(!r.ok){let e=await r.text();throw console.error("[DEBUG] Deepgram API error response:",e),Error(`Deepgram transcription failed: ${r.status} ${e}`)}let o=await r.json();return o.results?.channels?.[0]?.alternatives?.[0]?.transcript?.trim()||""}async function w(e){try{let t=await e.json();console.log("[DEBUG] Request body received:",t);let{sessionId:r,pathOrUrl:o,userId:i="anonymous"}=t;if(!r||!o)return n.NextResponse.json({error:"Missing required fields: sessionId and pathOrUrl are required."},{status:400});let s=await h(o),a=await g(s),l=await m(a);if(console.log("[DEBUG] Transcript obtained:",l),!l)return n.NextResponse.json({sessionId:r,transcript:"",chatResponse:"I didn't quite catch that. Could you please say it again?"});let d=r;if(await u._.session.findUnique({where:{id:r}}))console.log(`[DEBUG] Confirmed using existing session ID: ${d}`);else{let e;console.log("[DEBUG] Session not found. Creating a new session..."),!i||"anonymous"===i||(e=await u._.user.findUnique({where:{id:i}}))||console.warn(`[DEBUG] User with ID ${i} not found. Falling back to default user.`),e||(e=await u._.user.upsert({where:{email:"default@example.com"},update:{},create:{email:"default@example.com",name:"Default User"}})),d=(await u._.session.create({data:{userId:e.id}})).id,console.log(`[DEBUG] Created and using new session ID: ${d} for user: ${e.email}`)}console.log("[DEBUG] Sending transcript to /api/chat");let c="http://localhost:3000";if(!c||!c.startsWith("http"))throw console.error("[ERROR] NEXT_PUBLIC_BASE_URL is not defined or is invalid. Please set it in your .env.local file to the full URL of your application (e.g., http://localhost:3000)."),Error("Server configuration error: NEXT_PUBLIC_BASE_URL is not set.");let p=`${c}/api/chat`,f=await fetch(p,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:d,message:l,history:[]})});if(!f.ok){let e=await f.text();throw console.error(`[DEBUG] Call to /api/chat failed with status ${f.status}:`,e),Error("Failed to get a response from the chat service.")}let w=await f.json();return console.log("[DEBUG] Received response from /api/chat:",w),n.NextResponse.json({transcript:l,chatResponse:w.text,sessionId:w.sessionId})}catch(e){return console.error("[DEBUG] An unexpected error occurred in the POST handler:",e),n.NextResponse.json({error:"Internal Server Error",details:e.message},{status:500})}}let E=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/voice/route",pathname:"/api/voice",filename:"route",bundlePath:"app/api/voice/route"},resolvedPagePath:"C:\\Users\\Garima\\Desktop\\Mood_mate\\app\\api\\voice\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:U,staticGenerationAsyncStorage:y,serverHooks:B}=E,v="/api/voice/route";function x(){return(0,a.patchFetch)({serverHooks:B,staticGenerationAsyncStorage:y})}},72331:(e,t,r)=>{r.d(t,{_:()=>i});var o=r(53524);let i=global.prisma||new o.PrismaClient({log:["query"]})},62632:(e,t,r)=>{r.d(t,{h:()=>l,p:()=>a});var o=r(94738);let i="https://uhmjdujijoywhyrugplb.supabase.co",s=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!i)throw Error("Missing NEXT_PUBLIC_SUPABASE_URL. Set it in your environment.");if(!s)throw Error("Missing SUPABASE_SERVICE_ROLE_KEY. Set it in your environment.");let a=(0,o.eI)(i,s),n=e=>new Promise(t=>setTimeout(t,e));async function l(e,t={public:!0}){let r;for(let t=1;t<=3;t++){let{data:o,error:i}=await a.storage.getBucket(e);if(o&&!i)return o;if(i){if(r=i,404===i.status||/not.*found/i.test(i.message||""))break;await n(250*t);continue}break}for(let o=1;o<=3;o++){let{data:i,error:s}=await a.storage.createBucket(e,{public:t.public??!0,fileSizeLimit:t.fileSizeLimit,allowedMimeTypes:t.allowedMimeTypes});if(i&&!s)return i;if(s&&(/already exists/i.test(s.message||"")||409===s.status)){let{data:t}=await a.storage.getBucket(e);if(t)return t}r=s,await n(300*o)}throw Error(`Failed to ensure bucket "${e}": ${r?.message||"Unknown error"}`)}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[9276,5972,4738],()=>r(39349));module.exports=o})();